{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
    <div class="card mb-4">
        <img src="{{ url_for('static', filename='uploads/' + work.image_path.split('/')[-1]) }}" class="img-fluid" alt="{{ work.title }}">
        <div class="card-body">
            <h3 class="card-title">{{ work.title }}</h3>
            <p class="card-text">{{ work.description }}</p>
            <p class="card-text">
                <small class="text-muted">–ó–∞–≥—Ä—É–∂–µ–Ω–æ: {{ work.upload_date|datetimeformat }}</small>
            </p>
            <p class="card-text">
                <small class="text-muted">–ê–≤—Ç–æ—Ä: {{ work.username }}</small>
            </p>

            <!-- –õ–∞–π–∫–∏ -->
            <div class="position-relative">
            <p class="card-text">‚ù§Ô∏è <span id="likes-count-{{ work.id }}">{{ work.likes_count }}</span></p>
            {% if current_user.is_authenticated %}
                <img src="{{ url_for('static', filename='img/' + ('filled_like.png' if work.user_liked else 'empty_like.png')) }}"
                     id="like-btn-{{ work.id }}"
                     class="like-icon"
                     onclick="toggleLike({{ work.id }})"
                     style="cursor: pointer; width: 40px;">
            {% else %}
                <p><a href="{{ url_for('login') }}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –ª–∞–π–∫–Ω—É—Ç—å.</p>
            {% endif %}

        </div>


            <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–∞–±–æ—Ç—ã) -->
            {% if current_user.is_authenticated and current_user.id == work.user_id %}
                <form action="{{ url_for('delete_work', work_id=work.id) }}" method="POST" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–∞–±–æ—Ç—É?');" class="mt-2">
                    <button type="submit" class="btn btn-danger">üóë –£–¥–∞–ª–∏—Ç—å —Ä–∞–±–æ—Ç—É</button>
                </form>
            {% endif %}
        </div>
    </div>

    <!-- –†–∞–∑–¥–µ–ª –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>
    {% for comment in comments %}
        <div class="card mb-2">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">
                    {{ comment.username }} ‚Äì {{ comment.comment_date|datetimeformat }}
                </h6>
                <p class="card-text">{{ comment.text }}</p>
            </div>
        </div>
    {% else %}
        <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
    {% endfor %}

    {% if current_user.is_authenticated %}
        <form action="{{ url_for('add_comment', work_id=work.id) }}" method="POST" class="mt-3">
            <div class="mb-3">
                <label for="comment" class="form-label">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea name="comment" id="comment" rows="3" class="form-control" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
    {% else %}
        <p><a href="{{ url_for('login') }}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
    {% endif %}
</div>

<script>
    function toggleLike(workId) {
        fetch(`/like/${workId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`likes-count-${workId}`).textContent = data.likes_count;
                let likeBtn = document.getElementById(`like-btn-${workId}`) || document.getElementById("like-btn");
                if (likeBtn) {
                    likeBtn.src = data.liked
                        ? "{{ url_for('static', filename='img/filled_like.png') }}"
                        : "{{ url_for('static', filename='img/empty_like.png') }}";
                }
            });
    }
</script>
{% endblock %}
